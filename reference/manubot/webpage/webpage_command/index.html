


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>Webpage Command - manubot</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.63b94e9e.min.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.7f672a1f.min.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="lightgreen">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-manubotwebpagewebpage_command" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../../../.." title="manubot" class="md-header-nav__button md-logo" aria-label="manubot">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            manubot
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Webpage Command
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/manubot/manubot/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    manubot
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="manubot" class="md-nav__button md-logo" aria-label="manubot">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    manubot
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/manubot/manubot/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    manubot
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../LICENSE/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Reference
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Reference" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1" checked>
    
    <label class="md-nav__link" for="nav-3-1">
      Manubot
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Manubot" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Manubot
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../command/" title="Command" class="md-nav__link">
      Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../util/" title="Util" class="md-nav__link">
      Util
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-4" type="checkbox" id="nav-3-1-4">
    
    <label class="md-nav__link" for="nav-3-1-4">
      Cite
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Cite" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Cite
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/arxiv/" title="Arxiv" class="md-nav__link">
      Arxiv
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/citations/" title="Citations" class="md-nav__link">
      Citations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/cite_command/" title="Cite Command" class="md-nav__link">
      Cite Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/citekey/" title="Citekey" class="md-nav__link">
      Citekey
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/citeproc/" title="Citeproc" class="md-nav__link">
      Citeproc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/csl_item/" title="Csl Item" class="md-nav__link">
      Csl Item
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/curie/" title="Curie" class="md-nav__link">
      Curie
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/doi/" title="Doi" class="md-nav__link">
      Doi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/handlers/" title="Handlers" class="md-nav__link">
      Handlers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/isbn/" title="Isbn" class="md-nav__link">
      Isbn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/pubmed/" title="Pubmed" class="md-nav__link">
      Pubmed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/unpaywall/" title="Unpaywall" class="md-nav__link">
      Unpaywall
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/url/" title="Url" class="md-nav__link">
      Url
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/wikidata/" title="Wikidata" class="md-nav__link">
      Wikidata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/zotero/" title="Zotero" class="md-nav__link">
      Zotero
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-4-17" type="checkbox" id="nav-3-1-4-17">
    
    <label class="md-nav__link" for="nav-3-1-4-17">
      Tests
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tests" data-md-level="4">
      <label class="md-nav__title" for="nav-3-1-4-17">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_arxiv/" title="Test Arxiv" class="md-nav__link">
      Test Arxiv
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_citations/" title="Test Citations" class="md-nav__link">
      Test Citations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_cite_command/" title="Test Cite Command" class="md-nav__link">
      Test Cite Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_citekey/" title="Test Citekey" class="md-nav__link">
      Test Citekey
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_citekey_api/" title="Test Citekey Api" class="md-nav__link">
      Test Citekey Api
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_citeproc/" title="Test Citeproc" class="md-nav__link">
      Test Citeproc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_csl_item/" title="Test Csl Item" class="md-nav__link">
      Test Csl Item
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_curie/" title="Test Curie" class="md-nav__link">
      Test Curie
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_doi/" title="Test Doi" class="md-nav__link">
      Test Doi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_handlers/" title="Test Handlers" class="md-nav__link">
      Test Handlers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_isbn/" title="Test Isbn" class="md-nav__link">
      Test Isbn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_pubmed/" title="Test Pubmed" class="md-nav__link">
      Test Pubmed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_unpaywall/" title="Test Unpaywall" class="md-nav__link">
      Test Unpaywall
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_url/" title="Test Url" class="md-nav__link">
      Test Url
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_wikidata/" title="Test Wikidata" class="md-nav__link">
      Test Wikidata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cite/tests/test_zotero/" title="Test Zotero" class="md-nav__link">
      Test Zotero
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-5" type="checkbox" id="nav-3-1-5">
    
    <label class="md-nav__link" for="nav-3-1-5">
      Pandoc
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Pandoc" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Pandoc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pandoc/bibliography/" title="Bibliography" class="md-nav__link">
      Bibliography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pandoc/cite_filter/" title="Cite Filter" class="md-nav__link">
      Cite Filter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pandoc/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pandoc/util/" title="Util" class="md-nav__link">
      Util
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-6" type="checkbox" id="nav-3-1-6">
    
    <label class="md-nav__link" for="nav-3-1-6">
      Process
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Process" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Process
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/bibliography/" title="Bibliography" class="md-nav__link">
      Bibliography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/ci/" title="Ci" class="md-nav__link">
      Ci
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/manuscript/" title="Manuscript" class="md-nav__link">
      Manuscript
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/metadata/" title="Metadata" class="md-nav__link">
      Metadata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/process_command/" title="Process Command" class="md-nav__link">
      Process Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/requests_cache/" title="Requests Cache" class="md-nav__link">
      Requests Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/util/" title="Util" class="md-nav__link">
      Util
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-6-9" type="checkbox" id="nav-3-1-6-9">
    
    <label class="md-nav__link" for="nav-3-1-6-9">
      Tests
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tests" data-md-level="4">
      <label class="md-nav__title" for="nav-3-1-6-9">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_bibliography/" title="Test Bibliography" class="md-nav__link">
      Test Bibliography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_ci/" title="Test Ci" class="md-nav__link">
      Test Ci
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_metadata/" title="Test Metadata" class="md-nav__link">
      Test Metadata
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_process_command/" title="Test Process Command" class="md-nav__link">
      Test Process Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../process/tests/test_util/" title="Test Util" class="md-nav__link">
      Test Util
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-7" type="checkbox" id="nav-3-1-7">
    
    <label class="md-nav__link" for="nav-3-1-7">
      Tests
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tests" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-7">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/test_command/" title="Test Command" class="md-nav__link">
      Test Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/test_imports/" title="Test Imports" class="md-nav__link">
      Test Imports
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/test_readme/" title="Test Readme" class="md-nav__link">
      Test Readme
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tests/test_util/" title="Test Util" class="md-nav__link">
      Test Util
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1-8" type="checkbox" id="nav-3-1-8" checked>
    
    <label class="md-nav__link" for="nav-3-1-8">
      Webpage
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Webpage" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-8">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Webpage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Webpage Command
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Webpage Command" class="md-nav__link md-nav__link--active">
      Webpage Command
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkout_existing_versions" class="md-nav__link">
    checkout_existing_versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli_webpage" class="md-nav__link">
    cli_webpage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure_args" class="md-nav__link">
    configure_args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create_version" class="md-nav__link">
    create_version
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_versions" class="md-nav__link">
    get_versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ots_stamp" class="md-nav__link">
    ots_stamp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ots_upgrade" class="md-nav__link">
    ots_upgrade
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkout_existing_versions" class="md-nav__link">
    checkout_existing_versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli_webpage" class="md-nav__link">
    cli_webpage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure_args" class="md-nav__link">
    configure_args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create_version" class="md-nav__link">
    create_version
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_versions" class="md-nav__link">
    get_versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ots_stamp" class="md-nav__link">
    ots_stamp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ots_upgrade" class="md-nav__link">
    ots_upgrade
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/manubot/manubot/edit/master/reference/manubot/webpage/webpage_command.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-manubotwebpagewebpage_command">Module manubot.webpage.webpage_command</h1>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">from</span> <span class="nn">manubot.util</span> <span class="kn">import</span> <span class="n">shlex_join</span>

<span class="k">def</span> <span class="nf">cli_webpage</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Execute manubot webpage commands.</span>

<span class="sd">    args should be an argparse.Namespace object created by parser.parse_args.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">configure_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Running `manubot webpage` with the following args:</span><span class="se">\n</span><span class="s2">{args}&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>

        <span class="n">ots_upgrade</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">create_version</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">configure_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Perform additional processing of arguments that is not handled by argparse.</span>

<span class="sd">    Derive additional variables and add them to args.</span>

<span class="sd">    For example, add directories to args and create them if neccessary.</span>

<span class="sd">    Note that versions_directory is the parent of version_directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">args_dict</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># If --timestamp specified, check that opentimestamps-client is installed</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>

        <span class="n">ots_executable_path</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;ots&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ots_executable_path</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>

                <span class="s2">&quot;manubot webpage --timestamp was specified but opentimestamps-client not found on system. &quot;</span>

                <span class="s2">&quot;Setting --timestamp=False. &quot;</span>

                <span class="s2">&quot;Fix this by installing https://pypi.org/project/opentimestamps-client/&quot;</span>

            <span class="p">)</span>

            <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># Directory where Manubot outputs reside</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;output_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>

    <span class="c1"># Set webpage directory</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;webpage_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;webpage&quot;</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">webpage_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Create webpage/v directory (if it doesn&#39;t already exist)</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;versions_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">webpage_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">versions_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Checkout existing version directories</span>

    <span class="n">checkout_existing_versions</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># Apply --version argument defaults</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">manubot.process.ci</span> <span class="kn">import</span> <span class="n">get_continuous_integration_parameters</span>

        <span class="n">ci_params</span> <span class="o">=</span> <span class="n">get_continuous_integration_parameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ci_params</span><span class="p">:</span>

            <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ci_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;commit&quot;</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>

    <span class="c1"># Create empty webpage/v/version directory</span>

    <span class="n">version_directory</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">versions_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">version_directory</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;{version_directory} exists: replacing it with an empty directory&quot;</span>

        <span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">version_directory</span><span class="p">)</span>

    <span class="n">version_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;version_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_directory</span>

    <span class="c1"># Symlink webpage/v/latest to point to webpage/v/commit</span>

    <span class="n">latest_directory</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">versions_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;latest&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">latest_directory</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="ow">or</span> <span class="n">latest_directory</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>

        <span class="n">latest_directory</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">latest_directory</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">latest_directory</span><span class="p">)</span>

    <span class="n">latest_directory</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;latest_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latest_directory</span>

    <span class="c1"># Create freeze directory</span>

    <span class="n">freeze_directory</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">versions_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;freeze&quot;</span><span class="p">)</span>

    <span class="n">freeze_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="s2">&quot;freeze_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">freeze_directory</span>

    <span class="k">return</span> <span class="n">args</span>

<span class="k">def</span> <span class="nf">checkout_existing_versions</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Must populate webpage/v from the gh-pages branch to get history</span>

<span class="sd">    References:</span>

<span class="sd">    http://clubmate.fi/git-checkout-file-or-directories-from-another-branch/</span>

<span class="sd">    https://stackoverflow.com/a/2668947/4651668</span>

<span class="sd">    https://stackoverflow.com/a/16493707/4651668</span>

<span class="sd">    Command modeled after:</span>

<span class="sd">    git --work-tree=webpage checkout upstream/gh-pages -- v</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">checkout</span><span class="p">:</span>

        <span class="k">return</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>

        <span class="s2">&quot;git&quot;</span><span class="p">,</span>

        <span class="n">f</span><span class="s2">&quot;--work-tree={args.webpage_directory}&quot;</span><span class="p">,</span>

        <span class="s2">&quot;checkout&quot;</span><span class="p">,</span>

        <span class="n">args</span><span class="o">.</span><span class="n">checkout</span><span class="p">,</span>

        <span class="s2">&quot;--&quot;</span><span class="p">,</span>

        <span class="s2">&quot;v&quot;</span><span class="p">,</span>

    <span class="p">]</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>

        <span class="n">f</span><span class="s2">&quot;Attempting checkout with the following command:</span><span class="se">\n</span><span class="s2">{shlex_join(command)}&quot;</span>

    <span class="p">)</span>

    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="c1"># Addresses an odd behavior where git checkout stages v/* files that don&#39;t actually exist</span>

        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;Checkout returned a nonzero exit status. See output:</span><span class="se">\n</span><span class="s2">{output.rstrip()}&quot;</span>

        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;pathspec&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>

            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>

                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Manubot note: if there are no preexisting webpage versions (like for a newly created manuscript), &quot;</span>

                <span class="s2">&quot;the pathspec error above is expected and can be safely ignored.&quot;</span>

            <span class="p">)</span>  <span class="c1"># see https://github.com/manubot/rootstock/issues/183</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_version</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Populate the version directory for a new version.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Copy content/images to webpage/v/commit/images</span>

    <span class="n">images_src</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;content/images&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">images_src</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">images_src</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">version_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">))</span>

    <span class="c1"># Copy output files to to webpage/v/version/</span>

    <span class="n">renamer</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;manuscript.html&quot;</span><span class="p">:</span> <span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="s2">&quot;manuscript.pdf&quot;</span><span class="p">:</span> <span class="s2">&quot;manuscript.pdf&quot;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">renamer</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">src_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">src_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>

            <span class="k">continue</span>

        <span class="n">dst_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">version_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>

            <span class="n">ots_stamp</span><span class="p">(</span><span class="n">dst_path</span><span class="p">)</span>

    <span class="c1"># Create v/freeze to redirect to v/commit</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="s2">&quot;redirect-template.html&quot;</span><span class="p">)</span>

    <span class="n">redirect_html</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>

    <span class="n">redirect_html</span> <span class="o">=</span> <span class="n">redirect_html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;../{args.version}/&quot;</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">freeze_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">redirect_html</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_versions</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Extract versions from the webpage/v directory, which should each contain</span>

<span class="sd">    a manuscript.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">versions</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">versions_directory</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()}</span>

    <span class="n">versions</span> <span class="o">-=</span> <span class="p">{</span><span class="s2">&quot;freeze&quot;</span><span class="p">,</span> <span class="s2">&quot;latest&quot;</span><span class="p">}</span>

    <span class="n">versions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">versions</span>

<span class="k">def</span> <span class="nf">ots_upgrade</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Upgrade OpenTimestamps .ots files in versioned commit directory trees.</span>

<span class="sd">    Upgrades each .ots file with a separate ots upgrade subprocess call due to</span>

<span class="sd">    https://github.com/opentimestamps/opentimestamps-client/issues/71</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ots_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">get_versions</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

        <span class="n">ots_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">versions_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.ots&quot;</span><span class="p">))</span>

    <span class="n">ots_paths</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ots_path</span> <span class="ow">in</span> <span class="n">ots_paths</span><span class="p">:</span>

        <span class="n">process_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ots&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_ots_cache</span><span class="p">:</span>

            <span class="n">process_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--no-cache&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">process_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--cache&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ots_cache</span><span class="p">)])</span>

        <span class="n">process_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;upgrade&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ots_path</span><span class="p">)])</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>

            <span class="n">process_args</span><span class="p">,</span>

            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>

            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>

            <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&gt;&gt;&gt; {shlex_join(process.args)}</span><span class="se">\n</span><span class="s2">{process.stdout}&quot;</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

                <span class="n">f</span><span class="s2">&quot;OpenTimestamp upgrade failed with exit code {process.returncode}.</span><span class="se">\n</span><span class="s2">{message}&quot;</span>

            <span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Success! Timestamp complete&quot;</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">backup_path</span> <span class="o">=</span> <span class="n">ots_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ots.bak&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">backup_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">backup_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Restore original timestamp if failure</span>

                <span class="n">backup_path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">ots_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ots_stamp</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Timestamp a file using OpenTimestamps.</span>

<span class="sd">    This function calls `ots stamp path`.</span>

<span class="sd">    If `path` does not exist, this function does nothing.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">process_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ots&quot;</span><span class="p">,</span> <span class="s2">&quot;stamp&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>

    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>

        <span class="n">process_args</span><span class="p">,</span>

        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>

        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>

        <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;OpenTimestamp command returned nonzero code ({process.returncode}).</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">f</span><span class="s2">&quot;&gt;&gt;&gt; {shlex_join(process.args)}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">f</span><span class="s2">&quot;{process.stdout}&quot;</span>

        <span class="p">)</span>
</code></pre></div>


</details>
<h2 id="functions">Functions</h2>
<h3 id="checkout_existing_versions">checkout_existing_versions</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">checkout_existing_versions</span><span class="p">(</span>
    <span class="n">args</span>
<span class="p">)</span>
</code></pre></div>


<p>Must populate webpage/v from the gh-pages branch to get history
References:
http://clubmate.fi/git-checkout-file-or-directories-from-another-branch/
https://stackoverflow.com/a/2668947/4651668
https://stackoverflow.com/a/16493707/4651668
Command modeled after:
git --work-tree=webpage checkout upstream/gh-pages -- v</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">checkout_existing_versions</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Must populate webpage/v from the gh-pages branch to get history</span>

<span class="ss">    References:</span>

<span class="ss">    http://clubmate.fi/git-checkout-file-or-directories-from-another-branch/</span>

<span class="ss">    https://stackoverflow.com/a/2668947/4651668</span>

<span class="ss">    https://stackoverflow.com/a/16493707/4651668</span>

<span class="ss">    Command modeled after:</span>

<span class="ss">    git --work-tree=webpage checkout upstream/gh-pages -- v</span>

<span class="ss">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="k">not</span> <span class="n">args</span><span class="p">.</span><span class="n">checkout</span><span class="p">:</span>

        <span class="k">return</span>

    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>

        <span class="ss">&quot;git&quot;</span><span class="p">,</span>

        <span class="n">f</span><span class="ss">&quot;--work-tree={args.webpage_directory}&quot;</span><span class="p">,</span>

        <span class="ss">&quot;checkout&quot;</span><span class="p">,</span>

        <span class="n">args</span><span class="p">.</span><span class="n">checkout</span><span class="p">,</span>

        <span class="ss">&quot;--&quot;</span><span class="p">,</span>

        <span class="ss">&quot;v&quot;</span><span class="p">,</span>

    <span class="p">]</span>

    <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span>

        <span class="n">f</span><span class="ss">&quot;Attempting checkout with the following command:\n{shlex_join(command)}&quot;</span>

    <span class="p">)</span>

    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="k">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="k">STDOUT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">process</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="o">#</span> <span class="n">Addresses</span> <span class="n">an</span> <span class="n">odd</span> <span class="n">behavior</span> <span class="k">where</span> <span class="n">git</span> <span class="n">checkout</span> <span class="n">stages</span> <span class="n">v</span><span class="cm">/* files that don&#39;t actually exist</span>

<span class="cm">        subprocess.run([&quot;git&quot;, &quot;add&quot;, &quot;v&quot;], stdout=subprocess.PIPE)</span>

<span class="cm">    else:</span>

<span class="cm">        output = process.stdout.decode()</span>

<span class="cm">        message = (</span>

<span class="cm">            f&quot;Checkout returned a nonzero exit status. See output:\n{output.rstrip()}&quot;</span>

<span class="cm">        )</span>

<span class="cm">        if &quot;pathspec&quot; in output:</span>

<span class="cm">            message += (</span>

<span class="cm">                &quot;\nManubot note: if there are no preexisting webpage versions (like for a newly created manuscript), &quot;</span>

<span class="cm">                &quot;the pathspec error above is expected and can be safely ignored.&quot;</span>

<span class="cm">            )  # see https://github.com/manubot/rootstock/issues/183</span>

<span class="cm">        logging.warning(message)</span>
</code></pre></div>


</details>
<h3 id="cli_webpage">cli_webpage</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">cli_webpage</span><span class="p">(</span>
    <span class="n">args</span>
<span class="p">)</span>
</code></pre></div>


<p>Execute manubot webpage commands.
args should be an argparse.Namespace object created by parser.parse_args.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">cli_webpage</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Execute manubot webpage commands.</span>

<span class="ss">    args should be an argparse.Namespace object created by parser.parse_args.</span>

<span class="ss">    &quot;&quot;&quot;</span>

    <span class="n">configure_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">logging</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Running `manubot webpage` with the following args:\n{args}&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="k">timestamp</span><span class="p">:</span>

        <span class="n">ots_upgrade</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">create_version</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>


</details>
<h3 id="configure_args">configure_args</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">configure_args</span><span class="p">(</span>
    <span class="n">args</span>
<span class="p">)</span>
</code></pre></div>


<p>Perform additional processing of arguments that is not handled by argparse.
Derive additional variables and add them to args.
For example, add directories to args and create them if neccessary.
Note that versions_directory is the parent of version_directory.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">configure_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Perform additional processing of arguments that is not handled by argparse.</span>

<span class="ss">    Derive additional variables and add them to args.</span>

<span class="ss">    For example, add directories to args and create them if neccessary.</span>

<span class="ss">    Note that versions_directory is the parent of version_directory.</span>

<span class="ss">    &quot;&quot;&quot;</span>

    <span class="n">args_dict</span> <span class="o">=</span> <span class="n">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="o">#</span> <span class="k">If</span> <span class="c1">--timestamp specified, check that opentimestamps-client is installed</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="k">timestamp</span><span class="p">:</span>

        <span class="n">ots_executable_path</span> <span class="o">=</span> <span class="n">shutil</span><span class="p">.</span><span class="n">which</span><span class="p">(</span><span class="ss">&quot;ots&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">not</span> <span class="n">ots_executable_path</span><span class="p">:</span>

            <span class="n">logging</span><span class="p">.</span><span class="n">error</span><span class="p">(</span>

                <span class="ss">&quot;manubot webpage --timestamp was specified but opentimestamps-client not found on system. &quot;</span>

                <span class="ss">&quot;Setting --timestamp=False. &quot;</span>

                <span class="ss">&quot;Fix this by installing https://pypi.org/project/opentimestamps-client/&quot;</span>

            <span class="p">)</span>

            <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">False</span>

    <span class="o">#</span> <span class="n">Directory</span> <span class="k">where</span> <span class="n">Manubot</span> <span class="n">outputs</span> <span class="n">reside</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;output_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="ss">&quot;output&quot;</span><span class="p">)</span>

    <span class="o">#</span> <span class="k">Set</span> <span class="n">webpage</span> <span class="n">directory</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;webpage_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="ss">&quot;webpage&quot;</span><span class="p">)</span>

    <span class="n">args</span><span class="p">.</span><span class="n">webpage_directory</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

    <span class="o">#</span> <span class="k">Create</span> <span class="n">webpage</span><span class="o">/</span><span class="n">v</span> <span class="n">directory</span> <span class="p">(</span><span class="k">if</span> <span class="n">it</span> <span class="n">doesn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">already</span> <span class="n">exist</span><span class="p">)</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;versions_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">webpage_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="ss">&quot;v&quot;</span><span class="p">)</span>

    <span class="n">args</span><span class="p">.</span><span class="n">versions_directory</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

    <span class="o">#</span> <span class="n">Checkout</span> <span class="k">existing</span> <span class="k">version</span> <span class="n">directories</span>

    <span class="n">checkout_existing_versions</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="o">#</span> <span class="n">Apply</span> <span class="c1">--version argument defaults</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="k">version</span> <span class="k">is</span> <span class="k">None</span><span class="p">:</span>

        <span class="k">from</span> <span class="n">manubot</span><span class="p">.</span><span class="n">process</span><span class="p">.</span><span class="n">ci</span> <span class="n">import</span> <span class="n">get_continuous_integration_parameters</span>

        <span class="n">ci_params</span> <span class="o">=</span> <span class="n">get_continuous_integration_parameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ci_params</span><span class="p">:</span>

            <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ci_params</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="ss">&quot;commit&quot;</span><span class="p">,</span> <span class="ss">&quot;local&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ss">&quot;local&quot;</span>

    <span class="o">#</span> <span class="k">Create</span> <span class="n">empty</span> <span class="n">webpage</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="k">version</span> <span class="n">directory</span>

    <span class="n">version_directory</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">versions_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="k">version</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">version_directory</span><span class="p">.</span><span class="n">is_dir</span><span class="p">():</span>

        <span class="n">logging</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="ss">&quot;{version_directory} exists: replacing it with an empty directory&quot;</span>

        <span class="p">)</span>

        <span class="n">shutil</span><span class="p">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">version_directory</span><span class="p">)</span>

    <span class="n">version_directory</span><span class="p">.</span><span class="n">mkdir</span><span class="p">()</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;version_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_directory</span>

    <span class="o">#</span> <span class="n">Symlink</span> <span class="n">webpage</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">latest</span> <span class="k">to</span> <span class="n">point</span> <span class="k">to</span> <span class="n">webpage</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="k">commit</span>

    <span class="n">latest_directory</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">versions_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="ss">&quot;latest&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">latest_directory</span><span class="p">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="k">or</span> <span class="n">latest_directory</span><span class="p">.</span><span class="n">is_file</span><span class="p">():</span>

        <span class="n">latest_directory</span><span class="p">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="n">elif</span> <span class="n">latest_directory</span><span class="p">.</span><span class="n">is_dir</span><span class="p">():</span>

        <span class="n">shutil</span><span class="p">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">latest_directory</span><span class="p">)</span>

    <span class="n">latest_directory</span><span class="p">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="k">version</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;latest_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latest_directory</span>

    <span class="o">#</span> <span class="k">Create</span> <span class="k">freeze</span> <span class="n">directory</span>

    <span class="n">freeze_directory</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">versions_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="ss">&quot;freeze&quot;</span><span class="p">)</span>

    <span class="n">freeze_directory</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

    <span class="n">args_dict</span><span class="p">[</span><span class="ss">&quot;freeze_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">freeze_directory</span>

    <span class="k">return</span> <span class="n">args</span>
</code></pre></div>


</details>
<h3 id="create_version">create_version</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">create_version</span><span class="p">(</span>
    <span class="n">args</span>
<span class="p">)</span>
</code></pre></div>


<p>Populate the version directory for a new version.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">create_version</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Populate the version directory for a new version.</span>

<span class="ss">    &quot;&quot;&quot;</span>

    <span class="o">#</span> <span class="k">Copy</span> <span class="n">content</span><span class="o">/</span><span class="n">images</span> <span class="k">to</span> <span class="n">webpage</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="k">commit</span><span class="o">/</span><span class="n">images</span>

    <span class="n">images_src</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="ss">&quot;content/images&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">images_src</span><span class="p">.</span><span class="k">exists</span><span class="p">():</span>

        <span class="n">shutil</span><span class="p">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">images_src</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">version_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="ss">&quot;images&quot;</span><span class="p">))</span>

    <span class="o">#</span> <span class="k">Copy</span> <span class="k">output</span> <span class="n">files</span> <span class="k">to</span> <span class="k">to</span> <span class="n">webpage</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="k">version</span><span class="o">/</span>

    <span class="n">renamer</span> <span class="o">=</span> <span class="err">{</span><span class="ss">&quot;manuscript.html&quot;</span><span class="p">:</span> <span class="ss">&quot;index.html&quot;</span><span class="p">,</span> <span class="ss">&quot;manuscript.pdf&quot;</span><span class="p">:</span> <span class="ss">&quot;manuscript.pdf&quot;</span><span class="err">}</span>

    <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="k">in</span> <span class="n">renamer</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">src_path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">output_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">not</span> <span class="n">src_path</span><span class="p">.</span><span class="k">exists</span><span class="p">():</span>

            <span class="k">continue</span>

        <span class="n">dst_path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">version_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

        <span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="k">timestamp</span><span class="p">:</span>

            <span class="n">ots_stamp</span><span class="p">(</span><span class="n">dst_path</span><span class="p">)</span>

    <span class="o">#</span> <span class="k">Create</span> <span class="n">v</span><span class="o">/</span><span class="k">freeze</span> <span class="k">to</span> <span class="n">redirect</span> <span class="k">to</span> <span class="n">v</span><span class="o">/</span><span class="k">commit</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="n">__file__</span><span class="p">).</span><span class="n">with_name</span><span class="p">(</span><span class="ss">&quot;redirect-template.html&quot;</span><span class="p">)</span>

    <span class="n">redirect_html</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">read_text</span><span class="p">()</span>

    <span class="n">redirect_html</span> <span class="o">=</span> <span class="n">redirect_html</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">f</span><span class="ss">&quot;../{args.version}/&quot;</span><span class="p">)</span>

    <span class="n">args</span><span class="p">.</span><span class="n">freeze_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="ss">&quot;index.html&quot;</span><span class="p">).</span><span class="n">write_text</span><span class="p">(</span><span class="n">redirect_html</span><span class="p">)</span>
</code></pre></div>


</details>
<h3 id="get_versions">get_versions</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_versions</span><span class="p">(</span>
    <span class="n">args</span>
<span class="p">)</span>
</code></pre></div>


<p>Extract versions from the webpage/v directory, which should each contain
a manuscript.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">get_versions</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Extract versions from the webpage/v directory, which should each contain</span>

<span class="ss">    a manuscript.</span>

<span class="ss">    &quot;&quot;&quot;</span>

    <span class="k">versions</span> <span class="o">=</span> <span class="err">{</span><span class="n">x</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="k">in</span> <span class="n">args</span><span class="p">.</span><span class="n">versions_directory</span><span class="p">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">is_dir</span><span class="p">()</span><span class="err">}</span>

    <span class="k">versions</span> <span class="o">-=</span> <span class="err">{</span><span class="ss">&quot;freeze&quot;</span><span class="p">,</span> <span class="ss">&quot;latest&quot;</span><span class="err">}</span>

    <span class="k">versions</span> <span class="o">=</span> <span class="n">sorted</span><span class="p">(</span><span class="k">versions</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">versions</span>
</code></pre></div>


</details>
<h3 id="ots_stamp">ots_stamp</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ots_stamp</span><span class="p">(</span>
    <span class="n">path</span>
<span class="p">)</span>
</code></pre></div>


<p>Timestamp a file using OpenTimestamps.
This function calls <code>ots stamp path</code>.
If <code>path</code> does not exist, this function does nothing.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="nf">ots_stamp</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    Timestamp a file using OpenTimestamps.</span>

<span class="s2">    This function calls `ots stamp path`.</span>

<span class="s2">    If `path` does not exist, this function does nothing.</span>

<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">process_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ots&quot;</span><span class="p">,</span> <span class="s2">&quot;stamp&quot;</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>

    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>

        <span class="n">process_args</span><span class="p">,</span>

        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>

        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">STDOUT</span><span class="p">,</span>

        <span class="n">universal_newlines</span><span class="o">=</span><span class="no">True</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="k">if</span> <span class="n">process</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">logging</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span>

            <span class="n">f</span><span class="s2">&quot;OpenTimestamp command returned nonzero code ({process.returncode}).\n&quot;</span>

            <span class="n">f</span><span class="s2">&quot;&gt;&gt;&gt; {shlex_join(process.args)}\n&quot;</span>

            <span class="n">f</span><span class="s2">&quot;{process.stdout}&quot;</span>

        <span class="p">)</span>
</code></pre></div>


</details>
<h3 id="ots_upgrade">ots_upgrade</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ots_upgrade</span><span class="p">(</span>
    <span class="n">args</span>
<span class="p">)</span>
</code></pre></div>


<p>Upgrade OpenTimestamps .ots files in versioned commit directory trees.
Upgrades each .ots file with a separate ots upgrade subprocess call due to
https://github.com/opentimestamps/opentimestamps-client/issues/71</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">ots_upgrade</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">    Upgrade OpenTimestamps .ots files in versioned commit directory trees.</span>

<span class="ss">    Upgrades each .ots file with a separate ots upgrade subprocess call due to</span>

<span class="ss">    https://github.com/opentimestamps/opentimestamps-client/issues/71</span>

<span class="ss">    &quot;&quot;&quot;</span>

    <span class="n">ots_paths</span> <span class="o">=</span> <span class="n">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="k">version</span> <span class="k">in</span> <span class="n">get_versions</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

        <span class="n">ots_paths</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">versions_directory</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="k">version</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="ss">&quot;**/*.ots&quot;</span><span class="p">))</span>

    <span class="n">ots_paths</span><span class="p">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ots_path</span> <span class="k">in</span> <span class="n">ots_paths</span><span class="p">:</span>

        <span class="n">process_args</span> <span class="o">=</span> <span class="p">[</span><span class="ss">&quot;ots&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">no_ots_cache</span><span class="p">:</span>

            <span class="n">process_args</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="ss">&quot;--no-cache&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">process_args</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="ss">&quot;--cache&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ots_cache</span><span class="p">)])</span>

        <span class="n">process_args</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="ss">&quot;upgrade&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">(</span><span class="n">ots_path</span><span class="p">)])</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>

            <span class="n">process_args</span><span class="p">,</span>

            <span class="k">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>

            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="k">STDOUT</span><span class="p">,</span>

            <span class="n">universal_newlines</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>

        <span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">f</span><span class="ss">&quot;&gt;&gt;&gt; {shlex_join(process.args)}\n{process.stdout}&quot;</span>

        <span class="k">if</span> <span class="n">process</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">logging</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span>

                <span class="n">f</span><span class="ss">&quot;OpenTimestamp upgrade failed with exit code {process.returncode}.\n{message}&quot;</span>

            <span class="p">)</span>

        <span class="n">elif</span> <span class="k">not</span> <span class="n">process</span><span class="p">.</span><span class="k">stdout</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="ss">&quot;Success! Timestamp complete&quot;</span><span class="p">:</span>

            <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">backup_path</span> <span class="o">=</span> <span class="n">ots_path</span><span class="p">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="ss">&quot;.ots.bak&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">backup_path</span><span class="p">.</span><span class="k">exists</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">process</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">backup_path</span><span class="p">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="o">#</span> <span class="n">Restore</span> <span class="n">original</span> <span class="k">timestamp</span> <span class="k">if</span> <span class="n">failure</span>

                <span class="n">backup_path</span><span class="p">.</span><span class="k">rename</span><span class="p">(</span><span class="n">ots_path</span><span class="p">)</span>
</code></pre></div>


</details>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../" title="Index" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Index
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Powered by
        <a href="http://timothycrosley.github.io/portray">portray.</a>
        You too can
        <a href="http://timothycrosley.github.io/portray">
          portray</a>
        your Python project well using automatic documentation.
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../../../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../../../..",
          features: [],
          search: Object.assign({
            worker: "../../../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>